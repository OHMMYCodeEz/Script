-- โหลด Fluent UI
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Roblox Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local success, PlayerClickAttack = pcall(function()
    return ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("PlayerClickAttack")
end)
if not success then
    warn("[Maru Hub] ⚠️ ไม่พบ Remote PlayerClickAttack")
    return
end

-- States
local selectedEnemy = nil
local tweenSpeed = 350
local attacking = false
local tweenNearby = false
local rebornEnabled = false
local autoSkillEnabled = false

-- สร้างปุ่ม Toggle UI บนหน้าจอ
local playerGui = player:WaitForChild("PlayerGui")
local toggleGui = Instance.new("ScreenGui")
toggleGui.Name = "ToggleUIButton"
toggleGui.IgnoreGuiInset = true
toggleGui.ResetOnSpawn = false
toggleGui.Parent = playerGui

local toggleButton = Instance.new("ImageButton")
toggleButton.Name = "FluentToggleButton"
toggleButton.Size = UDim2.new(0, 60, 0, 40)
toggleButton.Position = UDim2.new(0.5, -30, 0, 10)
toggleButton.BackgroundTransparency = 1
toggleButton.BorderSizePixel = 0
toggleButton.Image = "rbxassetid://72631420106515"
toggleButton.ScaleType = Enum.ScaleType.Fit
toggleButton.ZIndex = 10
toggleButton.Parent = toggleGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(1, 0)
corner.Parent = toggleButton

toggleButton.MouseButton1Click:Connect(function()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
    task.wait(0.1)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
end)

-- ✅ ตรวจสอบว่ามี workspace.Enemys
if not workspace:FindFirstChild("Enemys") then
    warn("[Maru Hub] ⚠️ ไม่พบ workspace.Enemys — โปรดตรวจสอบว่าเกมของคุณมีโฟลเดอร์นี้")
    return
end

-- Fluent Window
local Window = Fluent:CreateWindow({
    Title = "Maru Hub - Premium Script",
    SubTitle = "ac-v0.01c",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "swords" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- Utility Functions

-- Highlight Target
local function highlightTarget(target)
    if not target:FindFirstChild("Highlight") then
        local hl = Instance.new("Highlight")
        hl.Name = "Highlight"
        hl.FillColor = Color3.new(1, 0, 0)
        hl.OutlineColor = Color3.new(1, 1, 1)
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        hl.Parent = target
    end
end

-- Smart Pathing Placeholder (avoid obstacles)
-- Actual pathfinding logic can be added here if needed
local function getEnemyList()
    local names = {}
    for _, enemy in ipairs(workspace.Enemys:GetChildren()) do
        if enemy:IsA("Model") and enemy:FindFirstChild("HumanoidRootPart") then
            if not table.find(names, enemy.Name) then
                table.insert(names, enemy.Name)
            end
        end
    end
    return names
end

local function getHumanoid(model)
    return model and model:FindFirstChildOfClass("Humanoid")
end

local function isAlive(enemy)
    local h = getHumanoid(enemy)
    return h and h.Health > 0
end

local function attack(enemy)
    if not isAlive(enemy) then return end
    print("[DEBUG] Attacking:", enemy.Name)
    local dir = (enemy.HumanoidRootPart.Position - humanoidRootPart.Position).Unit
    humanoidRootPart.CFrame = CFrame.lookAt(humanoidRootPart.Position, humanoidRootPart.Position + dir)

    -- Click Attack
    pcall(function()
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        task.wait(0.01)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        PlayerClickAttack:FireServer({})
    end)

    -- Auto Skill
    if autoSkillEnabled then
        for _, key in ipairs({ Enum.KeyCode.Z, Enum.KeyCode.X, Enum.KeyCode.C, Enum.KeyCode.V }) do
            VirtualInputManager:SendKeyEvent(true, key, false, game)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false, key, false, game)
            task.wait(0.2)
        end
    end
end

local function findNearestAliveEnemy()
    local nearest, dist = nil, math.huge
    for _, enemy in ipairs(workspace.Enemys:GetChildren()) do
        if enemy:IsA("Model") and enemy:FindFirstChild("HumanoidRootPart") and isAlive(enemy) then
            local d = (enemy.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
            if d < dist then
                dist = d
                nearest = enemy
            end
        end
    end
    return nearest
end

-- UI Dropdown
local Dropdown = Tabs.Main:AddDropdown("EnemySelect", {
    Title = "Select Enemy",
    Values = getEnemyList(),
    Multi = false,
    Default = 1
})

-- ✅ ตั้งค่าค่า fallback ถ้าไม่มี selectedEnemy
selectedEnemy = getEnemyList()[1] or nil

selectedEnemy = getEnemyList()[1]

Dropdown:OnChanged(function(value)
    selectedEnemy = value
end)

Tabs.Main:AddButton({
    Title = "Refresh Enemy List",
    Callback = function()
        Dropdown:SetValues(getEnemyList())
    end
})

Tabs.Main:AddSlider("TweenSpeed", {
    Title = "Tween Speed",
    Default = 350,
    Min = 350,
    Max = 500,
    Rounding = 0,
    Callback = function(value)
        tweenSpeed = value
    end
})

Tabs.Main:AddToggle("TweenSelected", {
    Title = "Auto Farm Selected Enemy",
    Default = false,
    Callback = function(enabled)
        tweenSelected = enabled
        if enabled then
            task.spawn(function()
                while tweenSelected do
                    local enemy = workspace.Enemys:FindFirstChild(selectedEnemy)
                    if enemy and enemy:FindFirstChild("HumanoidRootPart") then
                        local dist = (enemy.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
                        local time = math.clamp(dist / tweenSpeed, 0.0001, 5000)
                        TweenService:Create(humanoidRootPart, TweenInfo.new(time, Enum.EasingStyle.Linear), {
                            CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                        }):Play()
                    end
                    task.wait(0.01)
                end
            end)
        end
    end
})

%1

Tabs.Main:AddToggle("TweenNearby", {
    Title = "Auto Farm Nearest Enemy",
    Default = false,
    Callback = function(enabled)
        tweenNearby = enabled
        if enabled then
            task.spawn(function()
                while tweenNearby do
                    local nearest, dist = nil, math.huge
                    for _, enemy in ipairs(workspace.Enemys:GetChildren()) do
                        if enemy:IsA("Model") and enemy:FindFirstChild("HumanoidRootPart") then
                            local d = (enemy.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
                            if d < dist then
                                dist = d
                                nearest = enemy
                            end
                        end
                    end
                    if nearest then
                        selectedEnemy = nearest.Name
                        local dir = (nearest.HumanoidRootPart.Position - humanoidRootPart.Position).Unit
                        humanoidRootPart.CFrame = CFrame.lookAt(humanoidRootPart.Position, humanoidRootPart.Position + dir)
                        local time = math.clamp(dist / tweenSpeed, 0.0001, 5000)
                        TweenService:Create(humanoidRootPart, TweenInfo.new(time, Enum.EasingStyle.Linear), {
                            CFrame = nearest.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                        }):Play()
                    end
                    task.wait(0.01)
                end
            end)
        end
    end
})

Tabs.Main:AddToggle("TweenSelected", {
    Title = "Auto Farm Selected Enemy",
    Default = false,
    Callback = function(enabled)
        tweenSelected = enabled
        if enabled then
            task.spawn(function()
                while tweenSelected do
                    local enemy = workspace.Enemys:FindFirstChild(selectedEnemy)
                    if enemy and enemy:FindFirstChild("HumanoidRootPart") then
                        local dist = (enemy.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
                        local time = math.clamp(dist / tweenSpeed, 0.0001, 5000)
                        TweenService:Create(humanoidRootPart, TweenInfo.new(time, Enum.EasingStyle.Linear), {
                            CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                        }):Play()
                    end
                    task.wait(0.01)
                end
            end)
        end
    end
})

-- Fluent Addons
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/specific-game")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
Fluent:Notify({ Title = "Fluent", Content = "Script Loaded", Duration = 8 })
SaveManager:LoadAutoloadConfig()
